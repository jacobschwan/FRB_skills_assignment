---
title: "Technical Skill Assignment"
author: "Jacob Schwan"
date: "`r Sys.Date()`"
output: 
    html_document:
        df_print: paged
        code_folding: show
        highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(gt)
```

```{r download-data}
high_url <- "https://www.federalreserve.gov/supervisionreg/files/cards-high-risk-2022.csv"
typical_url <- "https://www.federalreserve.gov/supervisionreg/files/cards-typical-risk-2022.csv"
low_url <- "https://www.federalreserve.gov/supervisionreg/files/cards-low-risk-2022.csv"

dl_data <- function(url) {
    save_file <- here::here(basename(url))
    if(!file.exists(save_file)) {
        download.file(url, save_file)
    } else {
        message(paste0(basename(url), " already exists."))
    }
    save_file
}

data_files <- c(high_url, typical_url, low_url) %>%
    map_chr(dl_data) %>%
    set_names(basename(.) %>%
                  str_extract("\\w+-risk"))

```

```{r import-data}
card_data <- data_files %>%
    map_dfr(vroom::vroom, .id = "risk_level")

card_data_fct <- card_data %>%
    mutate(creditcardtype_fct = factor(creditcardtype, labels = c("General purpose", "Private label")),
           currentcreditlimit_fct = cut(x = currentcreditlimit,
                                        breaks = c(-Inf, 1500, 7500, Inf),
                                        labels = c("$1,500 and less", "$1,501-$7,500", "Over $7,500")),
           dayspastdue_fct = cut(x = dayspastdue,
                                 breaks = c(-Inf, 29, Inf),
                                 labels = c("Current", "30+ Days past due")),
           producttype_fct = factor(producttype, labels = c("Co-brand", "Other")),
           activeflag_fct = factor(activeflag, labels = c("Open and active", "Other")),
           accountoriginationyear_fct = case_when(accountoriginationyear <= 2016 ~ "2016 and prior",
                                                  T ~ as.character(accountoriginationyear)) %>%
               as_factor(),
           monthendclosedrevokedflag_fct = factor(monthendclosedrevokedflag, labels = c("Open and active", "Other")),
           cycleendingbalance_fct = cut(cycleendingbalance,
                                        breaks = c(-Inf, 1000, 2000, 3000, 5000, 10000, Inf),
                                        labels = c("Under $1,000", 
                                                   "$1,000-$1,999",
                                                   "$2,000-$2,999",
                                                   "$3,000-$4,999",
                                                   "$5,000-$9,999",
                                                   "$10,000 and over"),
                                        right = FALSE),
           borrowerincome_fct = cut(borrowerincome,
                                    breaks = c(-Inf, 50000, 10000, Inf),
                                    labels = c("$50,000 and less", "$50,001-$100,000", "Over $100,000")),
           originalcreditlimit_fct = cut(originalcreditlimit,
                                        breaks = c(-Inf, 1500, 7500, Inf),
                                        labels = c("$1,500 and less", "$1,501-$7,500", "Over $7,500")),
           cycleendingretailapr_fct = cut(cycleendingretailapr,
                                          breaks = c(-Inf, 12, 15, 20, 24, Inf),
                                          labels = c("Under 12%",
                                                     "12%-14.99%",
                                                     "15%-19.99%",
                                                     "20%-23.99%",
                                                     "24% and over"),
                                          right = FALSE)
           ) 
```

```{r summary-pivot}
card_summaries <- card_data_fct %>%
    select(cycleendingbalance, risk_level, ends_with("fct")) %>%
    pivot_longer(!c(cycleendingbalance, risk_level), names_to = "group", values_to = "variables") %>%
    group_by(risk_level, group, variables) %>%
    summarise(balance = sum(cycleendingbalance), .groups = "drop_last") %>%
    mutate(pct_balance = balance/sum(balance),
           # group = as_factor(group) %>%
           #     fct_recode("Credit card type" = "creditcardtype_fct",
           #                "Current credit limit" = "currentcreditlimit_fct",
           #                "Days past due" = "dayspastdue_fct",
           #                "Product type" = "producttype_fct",
           #                "Month-end account status" = "activeflag_fct",
           #                "Account origination year" = "accountoriginationyear_fct",
           #                "Month-end close status" = "monthendclosedrevokedflag_fct",
           #                "Income at origination" = "borrowerincome_fct",
           #                "Original credit limit" = "originalcreditlimit_fct",
           #                "Interest rate at cycle end" = "cycleendingretailapr_fct")
           ) %>%
    ungroup() %>%
    select(-balance) %>%
    pivot_wider(names_from = risk_level,
                values_from = pct_balance,
                values_fill = 0) 

card_summaries
```

```{r}
card_summaries %>%
    gt(rowname_col = "variables") %>%
    tab_header(title = "Table 37. Summary statistics of selected variables in the portfolios of hypothetical credit card accounts",
               subtitle = "Percent as a share of cycle ending balance, except as noted") %>%
    tab_stubhead("Variables") %>%
    tab_row_group(group = "Interest rate at cycle end",
                  row = grep("cycleendingretailapr", group)) %>%
    tab_row_group(group = "Original credit limit",
                  row = grep("originalcreditlimit", group)) %>%
    tab_row_group(group = "Income at origination",
                  row = grep("borrowerincome", group)) %>%
    tab_row_group(group = "Cycle ending balance",
                  row = grep("cycleendingbalance", group)) %>%
    tab_row_group(group = "Month-end close status",
                  row = grep("monthend", group)) %>%
    tab_row_group(group = "Account origination year",
                  row = grep("originationyear", group)) %>%
    tab_row_group(group = "Month-end account status",
                  row = grep("activeflag", group)) %>%
    tab_row_group(group = "Product type",
                  row = grep("producttype", group)) %>%
    tab_row_group(group = "Days past due",
                  row = grep("dayspastdue", group)) %>%
    tab_row_group(group = "Current credit limit",
                  row = grep("currentcreditlimit", group)) %>%
    tab_row_group(group = "Credit card type",
                  row = grep("cardtype", group)) %>%
    cols_hide(c("group")) %>%
    cols_label(`high-risk` = "Higher-risk",
               `typical-risk` = "Typical",
               `low-risk` = "Lower-risk") %>%
    cols_move(c("typical-risk", "high-risk"),after = "low-risk") %>%
    fmt_number(columns = contains("risk"),
               decimals = 2,
               scale_by = 100)

```

